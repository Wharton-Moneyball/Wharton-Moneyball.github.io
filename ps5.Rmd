---
title: "Problem Set 5"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, fig.align = "center", include = FALSE) # set include = TRUE to see solutions in knitted RMarkdown
library(tidyverse)
```

# Data visualization with nflfastR 

We will now apply our newly acquired plotting skills to make some visualizations working with data from nflfastR. Let's load in our usual libraries, as well as nflfastR.

```{r load in libraries, include = TRUE}
library(tidyverse)
library(nflfastR)
library(ggplot2)
```

1. Let's load in the data for the 2023 season. This dataset contains play-by-play data for all games in the 2022 NFL season. 
```{r}
pbp_2023 <- load_pbp(2023)
```

1. We can see that there are more than 100 columns. Let's tackle specific questions one at a time. First, lets look at quarterback completions by filtering for where `play_type == pass` and then selecting the following columns in a new table caled `pbp_pass`. 
```{r filtering, include = TRUE}
pbp_pass <- pbp_2023 %>% 
  filter(play_type == "pass") %>% 
  select(play_type, pass_location, yards_gained, air_yards, yards_after_catch, 
         passer_player_name, complete_pass, incomplete_pass, cpoe)

head(pbp_pass)
```
2. nflfastR unfortunately doesn't include a position field to identify quarterbacks. To workaround, this, groupby player and filter for players with >150 pass attempts to remove players without sufficient play time. *Hint: pass attempts will be the sum of entries in complete_pass and incomplete_pass*
```{r filter for qbs}
pbp_pass <- pbp_pass %>% 
  group_by(passer_player_name) %>% 
  filter(sum(complete_pass, na.rm = TRUE) + sum(incomplete_pass, na.rm = TRUE) > 150) %>% 
  ungroup()
```

3. Let's take a preliminary look at how location might affect pass outcomes. First, use `!na` with `filter()` to filter out pass attempts without a location label. Then, create a bar plot to visualize the frequency of attempts in each pass location. Feed `pass_location` as a fill argument to make each bar a different color and make sure to use `labs()` to set axis and plot titles. You should see that ggplot automatically adds a legend for you!

```{r bar plot}
pbp_pass <- pbp_pass %>% 
  filter(!is.na(pass_location))

ggplot(pbp_pass, aes(x = pass_location, fill = pass_location)) +
  geom_bar() +
  labs(
    title = "Frequency of Pass Attempts by Location",
    x = "Pass Location",
    y = "Number of Attempts"
  ) +
  theme_minimal()
```

4. Let's look at the distribution of yards gained based on pass location with some box plots. Use `geom_boxplot()` to create a box plot of `yards_gained` by `pass_location`. Continue using fill and labs to format the plots nicely. 
```{r}
ggplot(pbp_pass, aes(x = pass_location, y = yards_gained, fill = pass_location)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Yards Gained by Pass Location",
    x = "Pass Location",
    y = "Yards Gained"
  ) +
  theme_minimal()
```

5. Completion yards over expected is a metric that adjusts for the difficulty of a QB's throw by calculating the yards completed above the expected amount based on throw timing, coverage, and location. Take a look at how `cpoe` may differ based on the pass location alone with `geom_violin()` Discuss your plots for 4 and 5 with other students. What conclusions can you draw about the pass location and how it may affect pass outcomes? 
```{r}
ggplot(pbp_pass, aes(x = pass_location, y = cpoe, fill = pass_location)) +
  geom_violin() +
  labs(
    title = "Distribution of CPOE by Pass Location",
    x = "Pass Location",
    y = "Completion Yards Over Expected"
  ) +
  theme_minimal()
```

6. Let's now turn to aggregated pass statistics per quarteback. Group by `passer_player_name` and create a table called `pbp_grouped` with columns `passer_player_name`, `attempts`, `avg_yards_gained`, and `avg_cpoe` using `reframe()`.  
```{r grouping}
pbp_grouped <- pbp_pass %>% 
  group_by(passer_player_name) %>% 
  reframe(
    attempts = sum(complete_pass, na.rm = TRUE) + sum(incomplete_pass, na.rm = TRUE),
    avg_yards_gained = mean(yards_gained, na.rm = TRUE),
    avg_cpoe = mean(cpoe, na.rm = TRUE)
  ) 

head(pbp_grouped)
```

7. We can first visualize how attempts and avg_yards_gained are related by using a scatterplot. Let's feed a color and size argument to `geom_point()` to visually change the appearance of your plot and make the points take up an appropriate amount of space. 
```{r scatter, include = TRUE}
ggplot(pbp_grouped, aes(x = attempts, y = avg_yards_gained)) +
  geom_point(color = 'lightcoral', size = 3) +
  labs(
    title = "Quarterback Attempts vs Average Yards Gained",
    x = "Attempts",
    y = "Average Yards Gained"
  ) +
  theme_minimal()
```

8. Next, add an abline to the plot using `geom_abline()` to see how linear the data may be. Use the `slope` and `intercept` arguments to set the slope to 0.01 and the intercept to 2. Set the linetype to dashed, and the color to black. 

```{r}
ggplot(pbp_grouped, aes(x = attempts, y = avg_yards_gained)) +
  geom_point(color = 'lightcoral', size = 3) +
  geom_abline(slope = 0.01, intercept = 2, linetype = "dashed", color = "black") +
  labs(
    title = "Quarterback Attempts vs Average Yards Gained",
    x = "Attempts",
    y = "Average Yards Gained"
  ) +
  theme_minimal()
```
9. Now, let's add a third variable. Set the color to equal `avg_cpoe` and use `scale_color_viridis_c()` to set the color scale. Make sure to label the color legend as "Average CPOE".

```{r}
ggplot(pbp_grouped, aes(x = attempts, y = avg_yards_gained, color = avg_cpoe)) +
  geom_point(size = 3) +
  geom_abline(slope = 0.01, intercept = 2, linetype = "dashed", color = "black") +
  scale_color_viridis_c() +
  labs(
    title = "Quarterback Attempts vs Average Yards Gained",
    x = "Attempts",
    y = "Average Yards Gained",
    color = "Average CPOE"
  ) +
  theme_minimal()
```

