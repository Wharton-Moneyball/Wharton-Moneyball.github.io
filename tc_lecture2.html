<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Lecture 2: The grammar of graphics and filtering data</title>

<script src="site_libs/header-attrs-2.14/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/darkly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>










<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"><img id="logo" style="width: 200px;" src="figures/WMA_logo.png" /></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-sign-in"></span>
     
    Get Started
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lecture0.html">Lecture 0</a>
    </li>
    <li>
      <a href="ps0.html">Problem Set 0</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-institution"></span>
     
    Academy
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lecture1.html">Lecture 1</a>
    </li>
    <li>
      <a href="lecture2.html">Lecture 2</a>
    </li>
    <li>
      <a href="lecture3.html">Lecture 3</a>
    </li>
    <li>
      <a href="lecture4.html">Lecture 4</a>
    </li>
    <li>
      <a href="lecture5.html">Lecture 5</a>
    </li>
    <li>
      <a href="lecture6.html">Lecture 6</a>
    </li>
    <li>
      <a href="lecture7.html">Lecture 7</a>
    </li>
    <li>
      <a href="lecture8.html">Lecture 8</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="ps1.html">Problem Set 1</a>
    </li>
    <li>
      <a href="ps2.html">Problem Set 2</a>
    </li>
    <li>
      <a href="ps3.html">Problem Set 3</a>
    </li>
    <li>
      <a href="ps4.html">Problem Set 4</a>
    </li>
    <li>
      <a href="ps5.html">Problem Set 5</a>
    </li>
    <li>
      <a href="ps6.html">Problem Set 6</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="lecture_nflscrapR.html">nflscrapR Lecture</a>
    </li>
    <li>
      <a href="psX.html">Problem Set X</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-dribbble"></span>
     
    Training Camp
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="tc_lecture1.html">Lecture 1</a>
    </li>
    <li>
      <a href="tc_lecture2.html">Lecture 2</a>
    </li>
    <li>
      <a href="tc_lecture3.html">Lecture 3</a>
    </li>
    <li>
      <a href="tc_lecture4.html">Lecture 4</a>
    </li>
    <li>
      <a href="tc_lecture5.html">Lecture 5</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="tc_ps1.html">Problem Set 1</a>
    </li>
    <li>
      <a href="tc_ps2.html">Problem Set 2</a>
    </li>
    <li>
      <a href="tc_ps3.html">Problem Set 3</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="tc_lecture_data_sources.html">Data Sources Lecture</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Lecture 2: The grammar of graphics and
filtering data</h1>

</div>


<p>We’re going to pick up right where we left off yesterday in <a
href="tc_ps1.html">Problem Set 1</a>, where you wrote a script to create
a <code>tbl</code> containg several shooting statistics for NBA players
between the 1996-97 season and the 2015-16 season. Your script could
look something like what is the code block below, and for reasons that
will become clear shortly, we are going to call our <code>tbl</code>
<code>raw_shooting</code> (remember: writing code in script files is
good practice!)</p>
<p>As we learned at the end of <a href="tc_lecture1.html">Lecture 1</a>,
rather than repeatedly referring to our <code>tbl</code>, we can use the
pipe <code>%&gt;%</code> to chain together our operations for a much
<em>cleaner</em> chunk of code:</p>
<div id="introduction-to-ggplot2" class="section level2">
<h2>Introduction to ggplot2</h2>
<p>We will use visualizations to answer some questions about the data.
Specifically, we will study the distribution of the individual columns
as well as try to understand the relationship between pairs of
variables. For instance, are players attempting and making more three
point shots now than they did 10 years ago?</p>
<p>Throughout the week, we will be using the popular <a
href="https://ggplot2.tidyverse.org"><code>ggplot2</code></a> package
(again created by Hadley Wickham and a member of the
<code>tidyverse</code>) for all of our data visualizations. The
<code>gg</code> stands for the <strong>grammar of graphics</strong>, an
intuitive framework for data visualization. Given a dataset, such as
<code>raw_shooting</code>, we want to map the columns to certain
<strong>aesthetics</strong> of a visualization, such as the x-axis,
y-axis, size, color, etc. Then a geometric object is used to represent
the aesthetics visually such as a barchart or scatterplot. This
framework separates the process of visualization into different
components: data, aesthetic mappings, and geometric objects. These
components are then added together (or <strong>layered</strong>) to
produce the final graph. The <code>ggplot2</code> package is the most
popular implementation of the <strong>grammar of graphics</strong> and
is relatively easy to use.</p>
<p>As you saw in Prof. Wyner’s lectures, histograms are a powerful way
to describe a single dataset. Let’s start with making a histogram of
field-goal percentage (FGP). To do so with <code>ggplot2</code>, we
start by telling <code>R</code> which <code>tbl</code> we want to use as
the data for the plot. This is done using the <code>ggplot()</code>
function:</p>
<p>As you can see, nothing is displayed! That’s because we’ve just
initialized the dataset to be used for creating the plot. Next, we need
to map variables/columns from the data to
<strong>aesthetics</strong>/properties of the plot. Examples
include:</p>
<ul>
<li><code>x</code>: the variable that will be on the x-axis</li>
<li><code>y</code>: the variable that will be on the y-axis</li>
<li><code>color</code>: the variable that categorizes data by color</li>
<li><code>shape</code>: the variable that categorizes data by shape</li>
</ul>
<p>For the histogram, we map FGP to the <code>x</code> aesthetic with
the <code>aes()</code> functions, displaying values of FGP along the
x-axis:</p>
<p>Now we can see an axis for FGP, but still no histogram! That’s
because we need to <strong>add</strong> the geometric layer of the
histogram to the plot. The various geometric objects available in
<code>ggplot2</code> are referred to as <code>geom</code>s, and these
ultimately determine the type of play that will be created. Examples
include:</p>
<ul>
<li><code>geom_point()</code>: creates a scatterplot</li>
<li><code>geom_histogram()</code>: creates a histogram</li>
<li><code>geom_line()</code>: creates a line</li>
<li><code>geom_boxplot()</code>: creates a boxplot</li>
</ul>
<p>To display the FGP histogram, we will simply add the
<code>geom_histogram()</code> layer to the plot using the <code>+</code>
operator:</p>
<p>And of course, we can equivalently generate the same figure by
<strong>piping</strong> our dataset into the <code>ggplot</code>
function. The remaining examples will use the pipe operator
<code>%&gt;%</code> for the remainder of this week, emphasizing how you
can manipulate the <code>tbl</code> with various other functions prior
to displaying the data:</p>
<p>Each <code>geom</code> has it various attributes that can be modified
whether by mapping variables with <code>aes</code> or <em>global</em>
settings that affects the final displayed plot. A common problem faced
with histograms is determining the width of the bins or number of bins -
how much smoothing do we want of the data? You might have noticed that
by default <code>geom_histogram</code> is using 30 bins and prints out a
message for us about this decision. We can easily modify the number of
bins in the <code>geom_histogram</code> function using the
<code>bins</code> argument:</p>
<p>Or we directly specify the width of the bins reflecting the range of
FGP included in each bin using <code>binwidth</code>:</p>
<p><strong>Now you should spend time making histograms of FTP and TPP,
and other variables created in code above. Discuss the differences with
others.</strong></p>
</div>
<div id="filtering" class="section level2">
<h2>Filtering</h2>
<p>By this point, it should be clear that there are a number of rather
curious features in our dataset. For instance, there seem to be several
players who have never made a field goal but have made every one of
their free throw attempts. As it turns out, we have several players who
have attempted fewer than 5 field goals in a single season. We’d like to
remove all of the players who have not attempted a considerable number
of field goal attempts and three point attempts in order to understand
how the rate and efficiency of three point shots has changed over
time.</p>
<p>The <code>filter()</code> function is used to pull out subsets of
observations that satisfy some logical condition like
<code>FGA &gt; 100</code> or <code>FGA &gt; 100</code> and
<code>FTA &gt; 50</code>. To make such comparisons in R, we have the
following operators available at our disposal:</p>
<ul>
<li><code>==</code> for “equal to”</li>
<li><code>!=</code> for “not equal to”</li>
<li><code>&lt;</code> and <code>&lt;=</code> for “less than” and “less
than or equal to”</li>
<li><code>&gt;</code> and <code>&gt;=</code> for “greater than” and
“greater than or equal to”</li>
<li><code>&amp;</code>, <code>|</code>, <code>!</code> for “AND” and
“OR” and “NOT”</li>
</ul>
<p>The code below filter out all of the players with at least 100 field
goals in a single season</p>
<p>When we run this code, you’ll notice that R prints out a
<code>tbl</code> with 6,295 rows.</p>
<p>We can also filter on more complicated conditions constructed using
the AND, OR, and NOT operators: <code>&amp;</code>, <code>|</code>, and
<code>!</code>. For instance, to filter observations with at least 100
field goal attempts OR 50 three point attempts, we would do</p>
<p>We may combine these constraints by enclosing them in
parantheses.</p>
<p>What if we wanted to pull out the observations corresponding to the
2015-16 and 2014-15 season? We could do something like
<code>filter(raw_shooting, (SEASON == 2016) | (SEASON == 2015))</code>,
which would be perfectly fine. However, what if we wanted data from
1998-99, 2011-12, and 2015-16? Typing a lot of expressions like
<code>SEASON == ...</code> would be rather tedious. The
<code>%in%</code> operator lets us avoid this tedium:</p>
<p>We could also filter out data from the two lockout-shortened seasons,
1998-99 and 2011-12 using a combination of the NOT <code>!</code>
operator and <code>%in%</code>.</p>
<p>For the remainder of this module, we will focus on the non-lockout
seasons (ie <code>!SEASON %in% c(1999, 2012, 2016)</code>) but we still
need to determine a cutoff for FGA and TPA. Let’s start by making
histograms of the two variables to see their individual distributions,
and rather than creating a new temporary <code>tbl</code> we’ll take
advantage of the <code>%&gt;%</code>. First for FGA,</p>
<p>And now for TPA,</p>
<p>It might not make sense however to make a cutoff for FGA and TPA
without considering their relationship.</p>
</div>
<div id="bivariate-plots-for-continuous-data" class="section level2">
<h2>Bivariate plots for continuous data</h2>
<p>We can proceed to view the <strong>joint</strong> distribution of FGA
and TPA, the relationship between the two variables, by displaying a
scatterplot of the data. Obviously, as TPA increases the FGA will
increase (since FGA is the sum of TPA and number of two-point attempts).
We create a scatterplot by mapping multiple variables to <code>x</code>
and <code>y</code>, and use <code>geom_point</code> to display the
desired geometric object of points instead of
<code>geom_histogram</code> from before.</p>
<p>Immediately, we notice a few things about the figure. First, we see
the clear relationship between TPA and FGA - where where TPA provides
the lower threshold on FGA (remember why is this expected). We also see
what appears to be a group of points with a smaller number of
three-point attempts displaying a range in values for FGA, while a main
block of points shows an clear increasing relationship. A major drawback
of this scatterplot is its inability to show the relative density of
points. For instance, all we see is a solid black mass for the lower
range of values for both TPA and FGA - making it hard to determine where
an appropriate cutoff should be made.</p>
<p>One way to address this is to use <em>alpha-blending</em> to change
the transparency of each point. When there are many points plotted in
the same region, that region will appear darker. Just like
<code>binwidth</code> or <code>bins</code> for
<code>geom_histogram</code>, <code>geom_point</code> has settings we can
change such as the <code>alpha</code> setting in this case which ranges
from 0 (completely transparent) to 1 (solid and opaque, the
default).</p>
<p>Now we have a much better idea of where the majority of points are,
with a clear group of players displaying a smaller number of TPA.
Another type of plot commonly used in this situation is a
<strong>heatmap</strong> which you can thnk of as a two-dimensional
histogram. To form a heatmap, you start by dividing the coordinate plane
into many evenly-sized two-dimensional bins and then count the number of
points within each bin. You then color the bin according to the count.
While you can conceptually make the bins any shape you want, there are
two popular conventions: rectangular binning and hexagonal binning. For
this plot, we will focus on rectangular binning, using the
<code>geom_bin2d()</code> function.</p>
<p>Now we have a color scale that has appeared to tell us the number of
points in each bin. Just like histograms, we can increase the number of
bins to get a much more high-resolution view of our data.</p>
<p>In this example, using <code>geom_point</code> with lower values for
<code>alpha</code> provides a clear interpretation for where to make the
cutoff. Given the histograms we previously made for each variable as
well, let’s use a cutoff of <code>TPA &gt; 50</code> and
<code>FGA &gt; 150</code>. We can create the scatterplot as before but,
to demonstrate a convenient feature of <code>ggplot2</code>, we’ll now
assign the plot to a variable named <code>fga_tpa_plot</code>,</p>
<p>Notice how this code runs without displaying the plot. To display it
we simply run <code>fga_tpa_plot</code> in the console and the plot
appear,</p>
<p>Now we’re going to annotate this plot with the cutoffs we’ve
determined. To do so, we’re going to add a vertical line to provide the
cutoff for the minimum value of TPA, and a horizontal line for the
minimum value of FGA. Both of these can be accomplished using the
<code>geom</code>s <code>geom_vline</code> and <code>geom_hline</code>
where we specify for each the values for the intercepts to draw the
lines at. Since we’ve stored the plot in <code>fga_tpa_plot</code>, we
can add these layers with the <code>+</code> operator to
<code>fga_tpa_plot</code> directly:</p>
<p>This provides us with a good indication of what we’re cutting off,
but we should distinguish these lines separately from the points more.
Since these are both <code>geom</code>s with their own set of
attributes, we’ll change the color and make the line type to be
dashed,</p>
<p>Although <code>ggplot2</code> automatically provides axis labels
based on the variables we’ve mapped to the aesthetics in
<code>aes</code>, we really need text describing what is shown in the
plot. The easiest way to do this, is by adding a label layer with the
<code>labs()</code> function. Using <code>labs</code>, you can provide
it the same arguments as those inside <code>aes</code> as well as other
parts of the plot to label such as the title, subtitle, and caption. We
add appropriate labels to the plot above, with better descriptions for
the axes, as well as an informative subtitle regarding the red-dashed
lines:</p>
<p>As a reminder, the code chunk above is equivalent to running the
entire pipeline of code without creating any temporary objects, although
not recommended…</p>
</div>
<div id="saving-our-work" class="section level2">
<h2>Saving our work</h2>
<p>For next <a href="tc_lecture3.html">lecture</a> we will focus on the
dataset of players who attempted at least 150 field goals and 50 three
pointers in the non-lockout seasons. We’ll make this <em>clean</em>
dataset using the <code>filter()</code> function separating each
condition with commas, and refer to the resulting dataset as
<code>nba_shooting</code>. Finally, we’ll add a <code>mutate()</code>
line to create the <code>three_point_fg_rate = TPA / FGA</code> variable
from <a href="tc_lecture1.html">yesterday</a>.</p>
<p>While we can always re-run the commands used to produce this
<code>tbl</code> from our script, when data analyses become more
complicated, it is helpful to save these objects. <code>R</code> has its
own special file format for efficiently saving data on your
computer.</p>
<p>We will use the <code>save()</code> command.</p>
<p>Then when we want to <em>load</em> the data back into R, we can use
the <code>load()</code> function</p>
<p>Next, proceed to practice this lecture’s lessons in <a
href="tc_ps2.html">Problem Set 2</a>.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
