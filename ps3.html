<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Problem Set 3</title>

<script src="site_libs/header-attrs-2.14/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">WMb'22</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-institution"></span>
     
    Academy
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lecture0.html">Lecture 0</a>
    </li>
    <li class="dropdown-header">Problem Set 0</li>
    <li>
      <a href="tc_lecture0.html">Lecture 0</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-dribbble"></span>
     
    Training Camp
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="tc_lecture0.html">Lecture 0</a>
    </li>
    <li>
      <a href="tc_lecture1.html">Lecture 1</a>
    </li>
    <li>
      <a href="tc_ps1.html">Problem Set 1</a>
    </li>
    <li>
      <a href="tc_lecture2.html">Lecture 2</a>
    </li>
    <li>
      <a href="tc_ps2.html">Problem Set 2</a>
    </li>
    <li>
      <a href="tc_lecture3.html">Lecture 3</a>
    </li>
    <li>
      <a href="tc_ps3.html">Problem Set 3</a>
    </li>
    <li>
      <a href="tc_lecture4.html">Lecture 4</a>
    </li>
    <li>
      <a href="tc_lecture5.html">Lecture 5</a>
    </li>
    <li>
      <a href="more_resources.html">More resources</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Problem Set 3</h1>

</div>


<div id="mlb-batting-statistics" class="section level2">
<h2>MLB Batting Statistics</h2>
<p>In this problem set, you will practice using the pipe
<code>%&gt;%</code> and grouped calculations with batting statistics
taken from the Lahman dataset. We will compute the same statistics as we
did in <a href="ps2.html">Problem Set 2</a> and also standardize these
statistics within year, year and league, and also historical era.</p>
<p>To load the batting data into R, we can do the following</p>
<pre class="r"><code>&gt; library(tidyverse)
&gt; library(Lahman)
&gt; batting &lt;- as_tibble(Batting)</code></pre>
<p>Unfortunately, some statistics like hit-by-pitch (HBP) were not
recorded in the earlier decades of baseball. In the tbl, these missing
values are designated <code>NA</code>. To see some of these, we can run
the following code:</p>
<pre class="r"><code>&gt; batting %&gt;% 
+   select(playerID, yearID, teamID, AB, BB, HBP, SH, SF, IBB, GIDP)
# A tibble: 110,495 × 10
   playerID  yearID teamID    AB    BB   HBP    SH    SF   IBB  GIDP
   &lt;chr&gt;      &lt;int&gt; &lt;fct&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1 abercda01   1871 TRO        4     0    NA    NA    NA    NA     0
 2 addybo01    1871 RC1      118     4    NA    NA    NA    NA     0
 3 allisar01   1871 CL1      137     2    NA    NA    NA    NA     1
 4 allisdo01   1871 WS3      133     0    NA    NA    NA    NA     0
 5 ansonca01   1871 RC1      120     2    NA    NA    NA    NA     0
 6 armstbo01   1871 FW1       49     0    NA    NA    NA    NA     0
 7 barkeal01   1871 RC1        4     1    NA    NA    NA    NA     0
 8 barnero01   1871 BS1      157    13    NA    NA    NA    NA     1
 9 barrebi01   1871 FW1        5     0    NA    NA    NA    NA     0
10 barrofr01   1871 BS1       86     0    NA    NA    NA    NA     0
# … with 110,485 more rows</code></pre>
<p>A common convention for dealing with the missing values when
computing <span class="math inline">\(\text{PA}\)</span> is to replace
the <code>NA</code> with a <code>0</code>. To do this, we can use the
function <code>replace_na()</code> within a pipe as follows.</p>
<pre class="r"><code>&gt; batting &lt;- 
+   batting %&gt;% 
+   replace_na(list(IBB = 0, HBP = 0, SH = 0, SF = 0, GIDP = 0))
&gt; batting %&gt;% select(playerID, yearID, teamID, AB, BB, HBP, SH, SF, IBB)
# A tibble: 110,495 × 9
   playerID  yearID teamID    AB    BB   HBP    SH    SF   IBB
   &lt;chr&gt;      &lt;int&gt; &lt;fct&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1 abercda01   1871 TRO        4     0     0     0     0     0
 2 addybo01    1871 RC1      118     4     0     0     0     0
 3 allisar01   1871 CL1      137     2     0     0     0     0
 4 allisdo01   1871 WS3      133     0     0     0     0     0
 5 ansonca01   1871 RC1      120     2     0     0     0     0
 6 armstbo01   1871 FW1       49     0     0     0     0     0
 7 barkeal01   1871 RC1        4     1     0     0     0     0
 8 barnero01   1871 BS1      157    13     0     0     0     0
 9 barrebi01   1871 FW1        5     0     0     0     0     0
10 barrofr01   1871 BS1       86     0     0     0     0     0
# … with 110,485 more rows</code></pre>
<p>The syntax for <code>replace_na()</code> is a bit involved but the
basic idea is you have to specify the value you want to replace each
<code>NA</code>. When using <code>replace_na()</code> it is very
important to remember to include the <code>list(...)</code> bit.</p>
<ol style="list-style-type: decimal">
<li><p>Load the Lahman data and run the above code to create the tbl
<code>Batting</code>, which has replaced all of the <code>NA</code>’ in
the columns <code>IBB, HBP, SH, SF</code> and GIDP`.</p></li>
<li><p>Using the pipe <code>%&gt;%</code>, <code>mutate()</code>,
<code>filter()</code>, and <code>select()</code>, create a tbl
<code>batting</code> by:</p></li>
</ol>
<ul>
<li>Adding columns (with <code>mutate()</code>) for plate appearances
(PA), unintentional walks (uBB), singles (X1B), batting average (BA),
on-base percentage (OBP), on-base plus slugging (OPS), and weighted
On-Base Average (wOBA). Note that the formula for plate appearances is
<span class="math inline">\(\text{PA} = \text{AB} + \text{BB} +
\text{HBP} + \text{SH} + \text{SF}.\)</span> Formulae for the remaining
statistics are given in <a href="ps2.html">Problem Set 2</a>.</li>
<li>Pulling out only those rows of players with at least 502 plate
appearances <strong>and</strong> who played in either the AL or NL with
<code>filter()</code></li>
<li>Select the following columns: playerID, yearID, lgID, teamID, PA,
BA, OBP, OPS, wOBA.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Standardize each of BA, OBP, OPS, and wOBA using data from all of
the years. Who were the best and worst batters according to these four
metrics? Name the columns containing these new standardized values
<code>zBA_all</code>, <code>zOPB_all</code>, etc. <em>Remember, you must
re-define the <code>standardize()</code> function we wrote in <a
href="lecture3.html">Lecture 3</a></em></li>
</ol>
<pre class="r"><code>&gt; standardize &lt;- function(x){ (x - mean(x))/sd(x)}
&gt; batting &lt;-
+   batting %&gt;%
+   mutate(zBA_all = standardize(BA),
+          zOBP_all = standardize(OBP),
+          zOPS_all = standardize(OPS),
+          zwOBA_all = standardize(wOBA))</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Group <code>batting</code> by year and compute the standardized BA,
OBP, OPS, and wOBA within each year. Now who are the best and worst
batters according to the four measures? Name the columns containing
these new standardized values <code>zBA_year</code>,
<code>zOBP_year</code>, etc.</li>
</ol>
<pre class="r"><code>&gt; batting &lt;- 
+   batting %&gt;%
+   group_by(yearID) %&gt;%
+   mutate(zBA_year = standardize(BA),
+          zOBP_year = standardize(OBP),
+          zOPS_year = standardize(OPS),
+          zwOBA_year = standardize(wOBA))</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Remove the grouping by year and instead group by year and league.
Once again, standardize OBP, OPS, and wOBA within each league-year
combination. Are the best and worst batters still the same? Name the
columns containing these new standardized valuse
<code>zBA_year_lg</code>, <code>zOBP_year_lg</code>, etc.</li>
</ol>
<pre class="r"><code>&gt; batting &lt;- 
+   batting %&gt;%
+   ungroup() %&gt;% 
+   group_by(yearID) %&gt;%
+   mutate(zBA_year_lg = standardize(BA),
+          zOBP_year_lg = standardize(OBP),
+          zOPS_year_lg = standardize(OPS),
+          zwOBA_year_lg = standardize(wOBA))</code></pre>
<ol start="6" style="list-style-type: decimal">
<li>Remove the grouping you created in Problem 4. Bill James <a
href="https://www.billjamesonline.com/dividing_baseball_history_into_eras/">divided
baseball history into several eras</a> as follows:</li>
</ol>
<ul>
<li>Pioneer Era: 1871 – 1892</li>
<li>Spitball Era: 1893 – 1919</li>
<li>Landis Era: 1920 – 1946</li>
<li>Baby Boomer Era: 1947 – 1968</li>
<li>Artifical Turf Era: 1969 – 1992</li>
<li>Camden Yards Era: 1993 – present</li>
</ul>
<pre class="r"><code>&gt; batting &lt;-
+   batting %&gt;%
+   ungroup() %&gt;%
+   mutate(HIST_ERA = case_when(
+     1871 &lt;= yearID &amp; yearID &lt;= 1892 ~ &quot;Pioneer&quot;,
+     1893 &lt;= yearID &amp; yearID &lt;= 1919 ~ &quot;Spitball&quot;,
+     1920 &lt;= yearID &amp; yearID &lt;= 1946 ~ &quot;Landis&quot;,
+     1947 &lt;= yearID &amp; yearID &lt;= 1968 ~ &quot;Baby Boomer&quot;,
+     1969 &lt;= yearID &amp; yearID &lt;= 1992 ~ &quot;Artifical Turf&quot;,
+     1993 &lt;= yearID ~ &quot;Camden Yards&quot;)) %&gt;%
+   group_by(HIST_ERA) %&gt;%
+   mutate(zBA_hist = standardize(BA),
+          zOBP_hist = standardize(OBP),
+          zOPS_hist = standardize(OPS),
+          zwOBA_hist = standardize(wOBA))</code></pre>
<p>Use <code>mutate()</code> and <code>case_when()</code> (just like we
did in <a href="lecture2.html">Lecture 2</a>) to add a column called
Hist_era to <code>batting</code> that records the historical era.</p>
<ol start="7" style="list-style-type: decimal">
<li><p>Group <code>batting</code> by Hist_era and standardize BA, OBP,
OPS, and wOBA within historical era. Who are the best and worst batters
now? Name the columns containing these new stanardized values
<code>zBA_hist</code>, <code>zOBP_hist</code>, etc.</p></li>
<li><p>Remove the grouping you added in Problem 6.</p></li>
</ol>
</div>
<div id="mlb-payroll-and-winnings" class="section level2">
<h2>MLB Payroll and Winnings</h2>
<!--In lecture, Professory Wyner discussed the relationship between a team's payroll and its winning percentage.
In particular, for each season, he computed the "relative payroll" of each team by taking its payroll and dividing it by the median of payrolls of all teams in that seaosn.
We will replicate his analysis in the following problems.
-->
<p>Recall from <a href="ps2.html">Problem Set 2</a>, we plotted the
relative payroll of MLB teams against their winning percentage. In that
problem set, we read in a file that had included the relative payroll
for each team as a separate column. To get some additional practice with
dplyr, we will read in a different dataset and re-compute these relative
payrolls.</p>
<ol style="list-style-type: decimal">
<li>Remember the function we wrote in <a href="lecture3.html">Lecture
3</a> to standardize various statistics? It is reproduced below</li>
</ol>
<pre class="r"><code>&gt; standardize &lt;- function(x){
+   mu &lt;- mean(x, na.rm = TRUE)
+   sigma &lt;- sd(x, na.rm = TRUE)
+   return( (x - mu)/sigma)
+ }</code></pre>
<p>We need to write another function in order to compute “relative
payroll”. This function will take in a vector <code>x</code>, compute
its median, and then divides every element of <code>x</code> by the
median.</p>
<pre class="r"><code>&gt; relative &lt;- function(x){
+   med &lt;- median(x, na.rm = TRUE)
+   return( x/med )  
+ }</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Read in the <a href="data/mlb_payrolls.csv">MLB Payroll Data</a> and
load it into a tibble called <code>mlb_payrolls</code>.</li>
</ol>
<pre><code>Rows: 540 Columns: 5
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (2): Team, GM
dbl (3): Team_Payroll, Winning_Percentage, Year

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<ol start="3" style="list-style-type: decimal">
<li><p>Using the pipe <code>%&gt;%</code>, <code>group_by()</code>, and
<code>mutate()</code>, add a column to <code>mlb_payrolls</code> that
contains the relative payroll for each team.</p></li>
<li><p>Make a scatterplot of winning percentage against relative
payrolls. Comment on the relationship. Your scatterplot should be
identical to one you made in <a href="ps2.html">Problem Set 2</a>.
<img src="ps3_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p></li>
<li><p>Using the <code>summarize()</code> function, compute the average
team payroll and relative payroll for each year. Save these results in a
new tbl called <code>payroll_avg</code>.</p></li>
<li><p>Make a scatterplot that shows how team payrolls have evolved over
the year. Similar to what we did in <a href="lecture3.html">Lecture
3</a>, add a line to this scatterplot that shows the average team
payroll. Do the same thing for relative payroll. What do you notice
about the average team payroll and relative payroll?</p></li>
<li><p>As you will see in coming lectures, correlation is a measure of
the strength of the <em>linear</em> relationship between two variables.
The closer to +1 or -1 the correlation between two variables is, the
more predictable they are of each other. We can compute it using the
<code>cor()</code> function. Using <code>summary()</code> and
<code>cor()</code>, compute the correlation between relative payroll and
winning percentage within each year. What do you notice about how the
relationship between winning percentage and relative payroll changes
year to year?</p></li>
</ol>
<pre><code># A tibble: 18 × 2
    Year   cor
   &lt;dbl&gt; &lt;dbl&gt;
 1  1998 0.764
 2  1999 0.699
 3  2000 0.327
 4  2001 0.338
 5  2002 0.443
 6  2003 0.415
 7  2004 0.515
 8  2005 0.497
 9  2006 0.538
10  2007 0.495
11  2008 0.322
12  2009 0.504
13  2010 0.347
14  2011 0.408
15  2012 0.195
16  2013 0.330
17  2014 0.297
18  2015 0.281</code></pre>
</div>
<div id="a-challenge-question" class="section level2">
<h2>A Challenge Question</h2>
<p>Without running the code, work with your teammates to see if you can
figure out what the code below is doing.</p>
<pre class="r"><code>&gt; batting_2014_2015 &lt;-
+   batting %&gt;%
+   filter(yearID %in% c(2014, 2015)) %&gt;%
+   group_by(playerID) %&gt;%
+   filter(n() == 2) %&gt;% 
+   select(playerID, yearID, BA) %&gt;%
+   arrange(playerID)</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Run the code above and save the tbl
<code>batting_2014_2015.RData</code> to the file
“data/batting_2014_2015.RData”. We will return to this dataset in <a
href="lecture4.html">Lecture 4</a>.
<!-- We probably need to melt data here --></li>
</ol>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
